---
title: 数据库系统原理学习
tags: 未定义
categories: 数据库
date: 2018-06-28 12:00:02
---

# 事务

## ACID

### 1. 原子性（Atomicity）

事务被视为不可分割的最小单元，事务的所有操作要么全部提交成功，要么全部失败回滚。

回滚可以用回滚日志来实现，回滚日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。

### 2. 一致性（Consistency）

数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对一个数据的读取结果都是相同的。

### 3. 隔离性（Isolation）

一个事务所做的修改在最终提交以前，对其它事务是不可见的。

### 4. 持久性（Durability）

一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。

使用重做日志来保证持久性。



![](https://github.com/CyC2018/CS-Notes/blob/master/notes/pics/417bc315-4409-48c6-83e0-59e8d405429e.jpg)



# 并发一致问题

## 丢失修改

T1 和 T2 两个事务都对一个数据进行修改，T1 先修改，T2 随后修改，T2 的修改覆盖了 T1 的修改。

## 读脏数据

T1 修改一个数据，T2 随后读取这个数据。如果 T1 撤销了这次修改，那么 T2 读取的数据是脏数据。

## 不可重复读

T2 读取一个数据，T1 对该数据做了修改。如果 T2 再次读取这个数据，此时读取的结果和第一次读取的结果不同。

## 幻影读

T1 读取某个范围的数据，T2 在这个范围内插入新的数据，T1 再次读取这个范围的数据，此时读取的结果和和第一次读取的结果不同。



产生并发不一致性问题主要原因是破坏了事务的**隔离性**。

并发控制可以通过**封锁**来实现，但是封锁操作需要用户自己控制，相当复杂。

数据库管理系统提供了**事务的隔离级别**，让用户以一种更轻松的方式处理并发一致性问题。



# 封锁类型

### 1. 读写锁

- 排它锁（Exclusive），简写为 X 锁，又称写锁。  只允许一个事务读写
- 共享锁（Shared），简写为 S 锁，又称读锁。允许多个事务读，不允许写。多个事务可以加 S 锁

### 2. 意向锁
使用意向锁（Intention Locks）可以更容易地支持多粒度封锁。
已存在 行\表 级锁时，其他事务想要加锁，就需要遍历每一行是否已有锁，性能很差
意向锁引入了 IX/IS 表锁，表示一个事务想要在表中的某个数据行上加 X 锁或 S 锁
-  一个事务在获得某个数据行对象的 S 锁之前，必须先获得表的 IS 锁或者更强的锁；
-  一个事务在获得某个数据行对象的 X 锁之前，必须先获得表的 IX 锁。
通过引入意向锁，事务 T 想要对表 A 加 X 锁，只需要先检测是否有其它事务对表 A 加了 X/IX/S/IS 锁，如果有，则事务 T 加 X 锁失败。

各种锁的兼容关系如下：

| -      | X    | IX   | S    | IS   |
| ------ | ---- | ---- | ---- | ---- |
| **X**  | ×    | ×    | ×    | ×    |
| **IX** | ×    | √    | ×    | √    |
| **S**  | ×    | ×    | √    | √    |
| **IS** | ×    | √    | √    | √    |

解释如下：

- 任意 IS/IX 锁之间都是兼容的，因为它们只是表示想要对表加锁，而不是真正加锁；
- S 锁只与 S 锁和 IS 锁兼容，也就是说事务 T 想要对数据行加 S 锁，其它事务可以已经获得对表或者表中的行的 S 锁。

### 3. 封锁协议

### 4. 隔离级别

- **未提交读（READ UNCOMMITTED）** 事务中的修改，即使没有提交，对其它事务也是可见的。
- **提交读（READ COMMITTED）**一个事务只能读取已经提交的事务所做的修改。换句话说，一个事务所做的修改在提交之前对其它事务是不可见的。
- **可重复读（REPEATABLE READ）**  保证在同一个事务中多次读取同样数据的结果是一样的。
- **可串行化（SERIALIZABLE）** 强制事务串行执行。 需要加锁实现，而其它隔离级别通常不需要。

------

| 隔离级别 | 脏读 | 不可重复读 | 幻影读 |
| -------- | ---- | ---------- | ------ |
| 未提交读 | √    | √          | √      |
| 提交读   | ×    | √          | √      |
| 可重复读 | ×    | ×          | √      |
| 可串行化 | ×    | ×          |        |



todo

# reference

[<https://github.com/CyC2018/CS-Notes/blob/master/notes/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86.md>](<https://github.com/CyC2018/CS-Notes/blob/master/notes/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86.md>)